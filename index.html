<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Safe Turn</title>

<link rel="manifest" href="./manifest.json" />
<meta name="theme-color" content="#141414" />

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #eef2f5;
    }

    #map {
        width: 100%;
        height: 60vh;
    }

    .container {
        background: white;
        padding: 15px;
        border-radius: 12px;
        width: 92%;
        margin: -20px auto 0 auto;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }

    button {
        background: #3498db;
        border: none;
        padding: 12px;
        color: white;
        border-radius: 8px;
        width: 100%;
        margin-top: 10px;
        font-size: 16px;
        cursor: pointer;
    }

    button:active {
        opacity: 0.8;
    }

    .row {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    select {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #aaa;
    }

    footer {
        text-align: center;
        padding: 20px;
        color: #777;
    }

</style>
</head>
<body>

<div id="map"></div>

<div class="container">
    <h2>Safe Turn</h2>

    <button id="btnRecord">Gravar Movimento</button>

    <div class="row">
        <button id="btnUndo">Desfazer</button>
        <button id="btnClear">Limpar</button>
    </div>

    <div class="row">
        <select id="atrito">
            <option value="0.7">Asfalto Seco (0.70)</option>
            <option value="0.5">Asfalto Molhado (0.50)</option>
            <option value="0.4">Terra Seca (0.40)</option>
            <option value="0.25">Terra Molhada (0.25)</option>
        </select>

        <select id="veiculo">
            <option value="1">Padrão</option>
            <option value="0.9">Pesado</option>
        </select>

        <select id="margem">
            <option value="0.78">Alta (22%)</option>
            <option value="0.85">Média (15%)</option>
            <option value="0.92">Baixa (8%)</option>
        </select>
    </div>

    <button id="btnCalc">Calcular Curva</button>

    <button id="btnWA" style="background:#25d366">Compartilhar WhatsApp</button>

    <p id="result">Aguardando pontos...</p>
</div>

<footer>Feito com ❤️ por Everton Tezzon Ferreira</footer>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
let map, userMarker;
let points = [];
let recording = false;
let watchID = null;

function initMap() {
    map = L.map('map').setView([-23.5, -46.6], 15);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    userMarker = L.circleMarker([-23.5, -46.6], {
        radius: 10,
        color: "red",
        fillColor: "red",
        fillOpacity: 1
    }).addTo(map);

    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        userMarker.setLatLng([lat, lon]);
        map.setView([lat, lon], 18);
    });

    watchID = navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        userMarker.setLatLng([lat, lon]);

        if (recording) {
            points.push([lat, lon]);
        }
    });
}

document.getElementById("btnRecord").onclick = () => {
    recording = !recording;
    document.getElementById("btnRecord").innerText = recording ? "Gravando..." : "Gravar Movimento";

    if (!recording) {
        alert("Movimento gravado!");
    }
};

document.getElementById("btnUndo").onclick = () => {
    points.pop();
};

document.getElementById("btnClear").onclick = () => {
    points = [];
    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        map.setView([lat, lon], 18);
    });
};

document.getElementById("btnCalc").onclick = () => {
    if (points.length < 3) {
        alert("Grave 3 pontos!");
        return;
    }

    const A = points[0];
    const B = points[Math.floor(points.length / 2)];
    const C = points[points.length - 1];

    const R = calcRadius(A, B, C);

    const atrito = parseFloat(document.getElementById("atrito").value);
    const veiculo = parseFloat(document.getElementById("veiculo").value);
    const margem = parseFloat(document.getElementById("margem").value);

    const vel = Math.sqrt(R * 9.8 * atrito) * 3.6 * veiculo * margem;

    document.getElementById("result").innerHTML =
        "Raio estimado: " + R.toFixed(1) + " m<br>Velocidade recomendada: " + vel.toFixed(1) + " km/h";

    window.curveCenter = B;
    window.curveVel = vel.toFixed(1);
};

function calcRadius(A, B, C) {
    function dist(p, q) {
        return Math.sqrt(
            Math.pow(p[0] - q[0], 2) +
            Math.pow(p[1] - q[1], 2)
        );
    }
    const a = dist(B, C);
    const b = dist(A, C);
    const c = dist(A, B);
    const R = (a * b * c) / Math.sqrt((a + b + c) * (-a + b + c) * (a - b + c) * (a + b - c));
    return R * 100000;
}

document.getElementById("btnWA").onclick = () => {
    if (!window.curveCenter || !window.curveVel) {
        alert("Calcule antes!");
        return;
    }

    const lat = window.curveCenter[0];
    const lon = window.curveCenter[1];

    const link = `https://www.google.com/maps?q=${lat},${lon}`;

    const msg =
`Link:
${link}

Velocidade:
${window.curveVel} km/h`;

    const url = "https://wa.me/?text=" + encodeURIComponent(msg);
    window.open(url, "_blank");
};

initMap();
</script>

</body>
</html>